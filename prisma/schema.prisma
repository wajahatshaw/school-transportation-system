generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                        String
  createdAt                   DateTime?                     @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships                 Membership[]
  students                    Student[]
  drivers                     Driver[]
  compliances                 DriverComplianceDocument[]
  auditLogs                   AuditLog[]
  vehicles                    Vehicle[]
  routes                      Route[]

  @@map("tenants")
}

model Membership {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  role       String
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId])
  @@map("memberships")
}

model Student {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  grade      String?
  studentAddress String? @map("student_address")
  morningPickupTime    String? @map("morning_pickup_time")
  morningDropTime      String? @map("morning_drop_time")
  afternoonPickupTime  String? @map("afternoon_pickup_time")
  afternoonDropTime    String? @map("afternoon_drop_time")
  guardianName   String? @map("guardian_name")
  guardianPhone  String? @map("guardian_phone")
  schoolName     String? @map("school_name")
  schoolAddress  String? @map("school_address")
  schoolPhone    String? @map("school_phone")
  vehicleId      String? @map("vehicle_id") @db.Uuid
  driverId       String? @map("driver_id") @db.Uuid
  serialNo       String? @map("serial_no")
  runId          String? @map("run_id")
  routeId    String?  @map("route_id") @db.Uuid
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy  String? @map("deleted_by") @db.Uuid
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  route      Route?   @relation(fields: [routeId], references: [id])

  @@map("students")
}

model Driver {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  licenseNumber String? @map("license_number")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant                       @relation(fields: [tenantId], references: [id])
  compliances DriverComplianceDocument[]
  routes    Route[]

  @@map("drivers")
}

model DriverComplianceDocument {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  docType   String   @map("doc_type")
  issuedAt  DateTime? @map("issued_at") @db.Date
  expiresAt DateTime  @map("expires_at") @db.Date
  fileUrl   String?   @map("file_url")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  driver    Driver @relation(fields: [driverId], references: [id])

  @@map("driver_compliance_documents")
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  tableName String   @map("table_name")
  recordId  String   @map("record_id") @db.Uuid
  action    String
  before    Json?
  after     Json?
  userId    String?  @map("user_id") @db.Uuid
  ip        String?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@map("audit_logs")
}

model User {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  authUserId String?      @unique @map("auth_user_id")
  email      String       @unique
  createdAt  DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships Membership[]

  @@map("users")
}

model Vehicle {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  name          String
  capacity      Int
  licensePlate  String?   @map("license_plate")
  vehicleType   String?   @map("vehicle_type")
  manufactureYear Int?   @map("manufacture_year")
  model         String?
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy     String?   @map("deleted_by") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  routes        Route[]
  maintenances  VehicleMaintenanceDoc[]

  @@map("vehicles")
}

model VehicleMaintenanceDoc {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehicleId         String    @map("vehicle_id") @db.Uuid
  maintenanceDocUrl String?   @map("maintenance_doc_url")
  notes             String?
  scheduledDate     DateTime? @map("scheduled_date") @db.Date
  maintenanceStatus String    @default("pending") @map("maintenance_status")
  completedDate     DateTime? @map("completed_date") @db.Date
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy         String?   @map("deleted_by") @db.Uuid
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  vehicle           Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_maintenance_docs")
}

model Route {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  name      String
  type      String
  vehicleId String?   @map("vehicle_id") @db.Uuid
  driverId  String?   @map("driver_id") @db.Uuid
  stops     Json      @default("[]")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  vehicle   Vehicle?  @relation(fields: [vehicleId], references: [id])
  driver    Driver?   @relation(fields: [driverId], references: [id])
  students  Student[]

  @@map("routes")
}
