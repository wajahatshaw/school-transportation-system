generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                        String
  createdAt                   DateTime?                     @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships                 Membership[]
  students                    Student[]
  drivers                     Driver[]
  compliances                 DriverComplianceDocument[]
  auditLogs                   AuditLog[]
  vehicles                    Vehicle[]
  routes                      Route[]
  routeTrips                  RouteTrip[]
  attendanceRecords           AttendanceRecord[]
  complianceRules             ComplianceRule[]
  complianceSnapshots         ComplianceSnapshot[]
  complianceAlerts            ComplianceAlert[]
  invoices                    Invoice[]
  invoiceLineItems            InvoiceLineItem[]
  payments                    Payment[]

  @@map("tenants")
}

model Membership {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  role       String
  driverId   String?  @unique @map("driver_id") @db.Uuid
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
  driver     Driver?  @relation("DriverMembership", fields: [driverId], references: [id])

  @@unique([userId, tenantId])
  @@map("memberships")
}

model Student {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  grade      String?
  studentAddress String? @map("student_address")
  morningPickupTime    String? @map("morning_pickup_time")
  morningDropTime      String? @map("morning_drop_time")
  afternoonPickupTime  String? @map("afternoon_pickup_time")
  afternoonDropTime    String? @map("afternoon_drop_time")
  guardianName   String? @map("guardian_name")
  guardianPhone  String? @map("guardian_phone")
  schoolName     String? @map("school_name")
  schoolAddress  String? @map("school_address")
  schoolPhone    String? @map("school_phone")
  vehicleId      String? @map("vehicle_id") @db.Uuid
  driverId       String? @map("driver_id") @db.Uuid
  serialNo       String? @map("serial_no")
  runId          String? @map("run_id")
  routeId    String?  @map("route_id") @db.Uuid
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy  String? @map("deleted_by") @db.Uuid
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant     Tenant              @relation(fields: [tenantId], references: [id])
  route      Route?              @relation(fields: [routeId], references: [id])
  attendance AttendanceRecord[]
  invoiceLineItems InvoiceLineItem[]

  @@map("students")
}

model Driver {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String?  @map("email")
  authUserId String? @map("auth_user_id") @db.Uuid
  licenseNumber String? @map("license_number")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant      Tenant                       @relation(fields: [tenantId], references: [id])
  compliances DriverComplianceDocument[]
  routes      Route[]
  trips       RouteTrip[]
  membership  Membership?                  @relation("DriverMembership")

  @@map("drivers")
  @@index([tenantId, email])
  @@index([authUserId])
}

model DriverComplianceDocument {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  docType   String   @map("doc_type")
  issuedAt  DateTime? @map("issued_at") @db.Date
  expiresAt DateTime  @map("expires_at") @db.Date
  fileUrl   String?   @map("file_url")
  status    String?   @default("valid") @map("status")
  uploadedBy String?  @map("uploaded_by") @db.Uuid
  notes     String?   @map("notes") @db.Text
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  driver    Driver @relation(fields: [driverId], references: [id])

  @@map("driver_compliance_documents")
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  tableName String   @map("table_name")
  recordId  String   @map("record_id") @db.Uuid
  action    String
  before    Json?
  after     Json?
  userId    String?  @map("user_id") @db.Uuid
  ip        String?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@map("audit_logs")
}

model ComplianceRule {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  role            String   @default("driver")
  docType         String   @map("doc_type")
  required        Boolean  @default(true)
  graceDays       Int      @default(0) @map("grace_days")
  alertWindowsJson Json?   @map("alert_windows_json") @db.JsonB
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant          Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, role, docType])
  @@map("compliance_rules")
}

model ComplianceSnapshot {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  driverId        String?  @map("driver_id") @db.Uuid
  complianceScore Decimal? @map("compliance_score") @db.Decimal(5, 2)
  compliant       Boolean  @default(false)
  expiredCount    Int      @default(0) @map("expired_count")
  expiringCount   Int      @default(0) @map("expiring_count")
  missingCount    Int      @default(0) @map("missing_count")
  computedAt      DateTime @default(now()) @map("computed_at") @db.Timestamptz(6)
  detailsJson     Json?    @map("details_json") @db.JsonB
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant          Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, driverId, computedAt])
  @@map("compliance_snapshots")
}

model ComplianceAlert {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  driverId        String   @map("driver_id") @db.Uuid
  docId           String?  @map("doc_id") @db.Uuid
  alertType       String   @map("alert_type")
  alertWindowDays Int      @map("alert_window_days")
  sentAt          DateTime? @map("sent_at") @db.Timestamptz(6)
  channel         String?  @map("channel")
  dedupeKey       String   @unique @map("dedupe_key")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant          Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, driverId, alertType])
  @@index([dedupeKey])
  @@map("compliance_alerts")
}

model User {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  authUserId String?      @unique @map("auth_user_id")
  email      String       @unique
  createdAt  DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships Membership[]

  @@map("users")
}

model Vehicle {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  name          String
  capacity      Int
  licensePlate  String?   @map("license_plate")
  vehicleType   String?   @map("vehicle_type")
  manufactureYear Int?   @map("manufacture_year")
  model         String?
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy     String?   @map("deleted_by") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  routes        Route[]
  maintenances  VehicleMaintenanceDoc[]

  @@map("vehicles")
}

model VehicleMaintenanceDoc {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehicleId         String    @map("vehicle_id") @db.Uuid
  maintenanceDocUrl String?   @map("maintenance_doc_url")
  notes             String?
  scheduledDate     DateTime? @map("scheduled_date") @db.Date
  maintenanceStatus String    @default("pending") @map("maintenance_status")
  completedDate     DateTime? @map("completed_date") @db.Date
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy         String?   @map("deleted_by") @db.Uuid
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  vehicle           Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_maintenance_docs")
}

model Route {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  name      String
  type      String
  vehicleId String?   @map("vehicle_id") @db.Uuid
  driverId  String?   @map("driver_id") @db.Uuid
  stops     Json      @default("[]")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  vehicle   Vehicle?    @relation(fields: [vehicleId], references: [id])
  driver    Driver?     @relation(fields: [driverId], references: [id])
  students  Student[]
  trips     RouteTrip[]
  invoiceLineItems InvoiceLineItem[]

  @@map("routes")
}

model RouteTrip {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  routeId       String    @map("route_id") @db.Uuid
  tripDate      DateTime  @map("trip_date") @db.Date
  routeType     String    @map("route_type")
  driverId      String?   @map("driver_id") @db.Uuid
  confirmedAt   DateTime? @map("confirmed_at") @db.Timestamptz(6)
  confirmedBy   String?   @map("confirmed_by") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant        Tenant              @relation(fields: [tenantId], references: [id])
  route         Route               @relation(fields: [routeId], references: [id])
  driver        Driver?             @relation(fields: [driverId], references: [id])
  attendance    AttendanceRecord[]

  @@unique([routeId, tripDate, routeType])
  @@map("route_trips")
}

model AttendanceRecord {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tripId      String   @map("trip_id") @db.Uuid
  studentId   String   @map("student_id") @db.Uuid
  status      String
  markedAt    DateTime @default(now()) @map("marked_at") @db.Timestamptz(6)
  markedBy    String   @map("marked_by") @db.Uuid

  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  trip        RouteTrip  @relation(fields: [tripId], references: [id])
  student     Student    @relation(fields: [studentId], references: [id])

  @@unique([tripId, studentId])
  @@map("attendance_records")
}

model Invoice {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  invoiceNumber   String   @unique @map("invoice_number")
  status          String   @default("draft") // draft, sent, paid, overdue, cancelled
  issueDate       DateTime @map("issue_date") @db.Date
  dueDate         DateTime @map("due_date") @db.Date
  subtotal        Decimal  @db.Decimal(10, 2)
  tax             Decimal? @default(0) @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  paidAmount      Decimal  @default(0) @map("paid_amount") @db.Decimal(10, 2)
  outstandingAmount Decimal @map("outstanding_amount") @db.Decimal(10, 2)
  notes           String?  @db.Text
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  lineItems       InvoiceLineItem[]
  payments        Payment[]

  @@index([tenantId, status])
  @@index([tenantId, issueDate])
  @@index([tenantId, dueDate])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  itemType    String   @map("item_type") // "route", "student", "route-day"
  routeId     String?  @map("route_id") @db.Uuid
  studentId   String?  @map("student_id") @db.Uuid
  description String   @db.Text
  quantity    Decimal  @db.Decimal(10, 2) // number of days for route-days, count for students/routes
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  route       Route?   @relation(fields: [routeId], references: [id])
  student     Student? @relation(fields: [studentId], references: [id])

  @@index([invoiceId])
  @@index([tenantId])
  @@map("invoice_line_items")
}

model Payment {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  invoiceId       String   @map("invoice_id") @db.Uuid
  amount          Decimal  @db.Decimal(10, 2)
  paymentDate     DateTime @map("payment_date") @db.Date
  paymentMethod   String   @map("payment_method") // cash, check, bank_transfer, credit_card, other
  referenceNumber String?  @map("reference_number")
  notes           String?  @db.Text
  recordedBy      String   @map("recorded_by") @db.Uuid
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId, paymentDate])
  @@map("payments")
}
