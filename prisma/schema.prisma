generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                        String
  createdAt                   DateTime?                     @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships                 Membership[]
  students                    Student[]
  drivers                     Driver[]
  compliances                 DriverComplianceDocument[]
  auditLogs                   AuditLog[]
  vehicles                    Vehicle[]
  routes                      Route[]
  routeTrips                  RouteTrip[]
  attendanceRecords           AttendanceRecord[]

  @@map("tenants")
}

model Membership {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  role       String
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId])
  @@map("memberships")
}

model Student {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  grade      String?
  routeId    String?  @map("route_id") @db.Uuid
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy  String? @map("deleted_by") @db.Uuid
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant     Tenant              @relation(fields: [tenantId], references: [id])
  route      Route?              @relation(fields: [routeId], references: [id])
  attendance AttendanceRecord[]

  @@map("students")
}

model Driver {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  licenseNumber String? @map("license_number")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant      Tenant                       @relation(fields: [tenantId], references: [id])
  compliances DriverComplianceDocument[]
  routes      Route[]
  trips       RouteTrip[]

  @@map("drivers")
}

model DriverComplianceDocument {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  docType   String   @map("doc_type")
  issuedAt  DateTime? @map("issued_at") @db.Date
  expiresAt DateTime  @map("expires_at") @db.Date
  fileUrl   String?   @map("file_url")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String? @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  driver    Driver @relation(fields: [driverId], references: [id])

  @@map("driver_compliance_documents")
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  tableName String   @map("table_name")
  recordId  String   @map("record_id") @db.Uuid
  action    String
  before    Json?
  after     Json?
  userId    String?  @map("user_id") @db.Uuid
  ip        String?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@map("audit_logs")
}

model User {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  authUserId String?      @unique @map("auth_user_id")
  email      String       @unique
  createdAt  DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships Membership[]

  @@map("users")
}

model Vehicle {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  name          String
  capacity      Int
  licensePlate  String?   @map("license_plate")
  vehicleType   String?   @map("vehicle_type")
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy     String?   @map("deleted_by") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  routes        Route[]

  @@map("vehicles")
}

model Route {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  name      String
  type      String
  vehicleId String?   @map("vehicle_id") @db.Uuid
  driverId  String?   @map("driver_id") @db.Uuid
  stops     Json      @default("[]")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  vehicle   Vehicle?    @relation(fields: [vehicleId], references: [id])
  driver    Driver?     @relation(fields: [driverId], references: [id])
  students  Student[]
  trips     RouteTrip[]

  @@map("routes")
}

model RouteTrip {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  routeId       String    @map("route_id") @db.Uuid
  tripDate      DateTime  @map("trip_date") @db.Date
  routeType     String    @map("route_type")
  driverId      String?   @map("driver_id") @db.Uuid
  confirmedAt   DateTime? @map("confirmed_at") @db.Timestamptz(6)
  confirmedBy   String?   @map("confirmed_by") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant        Tenant              @relation(fields: [tenantId], references: [id])
  route         Route               @relation(fields: [routeId], references: [id])
  driver        Driver?             @relation(fields: [driverId], references: [id])
  attendance    AttendanceRecord[]

  @@unique([routeId, tripDate, routeType])
  @@map("route_trips")
}

model AttendanceRecord {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  tripId      String   @map("trip_id") @db.Uuid
  studentId   String   @map("student_id") @db.Uuid
  status      String
  markedAt    DateTime @default(now()) @map("marked_at") @db.Timestamptz(6)
  markedBy    String   @map("marked_by") @db.Uuid

  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  trip        RouteTrip  @relation(fields: [tripId], references: [id])
  student     Student    @relation(fields: [studentId], references: [id])

  @@unique([tripId, studentId])
  @@map("attendance_records")
}

